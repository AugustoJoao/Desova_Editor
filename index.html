<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desova Editor</title>
    <!-- TUI Image Editor CSS -->
    <link type="text/css" href="https://uicdn.toast.com/tui-color-picker/v2.2.7/tui-color-picker.css" rel="stylesheet">
    <link type="text/css" href="https://uicdn.toast.com/tui-image-editor/v3.15.3/tui-image-editor.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        .spinner {
            border-top-color: #3b82f6; /* Blue-500 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #tui-image-editor-container {
            height: 800px;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="gradient-bg">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-800">Desova Editor</h1>
            <p class="text-lg text-gray-600 mt-4">Envie uma imagem para remover o fundo, redimensionar e finalizar sua arte.</p>
        </header>

        <main class="bg-white rounded-2xl card-shadow p-6 md:p-8 max-w-7xl mx-auto">
            
            <div id="upload-section">
                <!-- File Input -->
                <div class="mb-6">
                     <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2">Escolha uma imagem:</label>
                    <div class="flex items-center justify-center w-full">
                        <label id="fileLabel" for="fileInput" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-blue-50 hover:border-blue-400 transition-colors duration-300">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para enviar</span> ou arraste e solte</p>
                                <p class="text-xs text-gray-500">PNG, JPG ou WEBP</p>
                            </div>
                            <input id="fileInput" type="file" class="hidden" accept="image/png, image/jpeg, image/webp" />
                        </label>
                    </div> 
                </div>
            </div>

            <!-- Loading and Message Display -->
            <div id="loading" class="hidden text-center my-4">
                <div class="inline-block spinner w-8 h-8 border-4 rounded-full" role="status"></div>
                <p class="text-gray-600 mt-2">Processando sua imagem, por favor aguarde...</p>
            </div>
            <div id="message" class="hidden text-center my-4 p-4 rounded-lg"></div>

            <!-- Image Preview Section (Visible after upload) -->
            <div id="preview-section" class="hidden">
                 <div id="preview-grid" class="grid grid-cols-1 justify-items-center gap-6 md:gap-8 mb-8">
                    <div class="text-center">
                        <h2 class="text-xl font-semibold mb-4">Imagem Original</h2>
                        <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden">
                            <img id="originalImage" src="https://placehold.co/400x400/e2e8f0/cbd5e0?text=Enviar+Imagem" alt="Original" class="max-w-full max-h-full object-contain">
                        </div>
                    </div>
                    <div id="processed-image-wrapper" class="text-center hidden">
                        <h2 class="text-xl font-semibold mb-4">Imagem Processada</h2>
                        <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden">
                            <img id="processedImage" src="https://placehold.co/400x400/e2e8f0/cbd5e0?text=Resultado" alt="Processada" class="max-w-full max-h-full object-contain">
                        </div>
                    </div>
                </div>
                <div id="preview-buttons" class="text-center mb-6 flex flex-wrap justify-center gap-4">
                    <button id="processButton" class="inline-flex items-center justify-center w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        Processar Imagem
                    </button>
                     <button id="removeButton" class="inline-flex items-center justify-center w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        Remover Imagem
                    </button>
                </div>
            </div>

            <!-- TUI Editor Section (Visible after processing) -->
            <div id="editor-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-4">Continue Editando</h2>
                <div id="tui-image-editor-container"></div>
                <div class="text-center mt-6">
                    <button id="downloadFinalButton" class="inline-flex items-center justify-center w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Baixar Imagem Final
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- TUI Image Editor JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.6.0/fabric.min.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui-code-snippet/v1.5.2/tui-code-snippet.min.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui-color-picker/v2.2.7/tui-color-picker.min.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui-image-editor/v3.15.3/tui-image-editor.min.js"></script>
    
    <script>
        // --- CONFIGURATION ---
        const BACKEND_BASE_URL = 'https://desova-editor.onrender.com'; 

        // DOM element references
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const uploadSection = document.getElementById('upload-section');
        const processButton = document.getElementById('processButton');
        const removeButton = document.getElementById('removeButton');
        const originalImage = document.getElementById('originalImage');
        const processedImage = document.getElementById('processedImage');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');
        const previewSection = document.getElementById('preview-section');
        const previewGrid = document.getElementById('preview-grid');
        const processedImageWrapper = document.getElementById('processed-image-wrapper');
        const previewButtons = document.getElementById('preview-buttons');
        const editorSection = document.getElementById('editor-section');
        const downloadFinalButton = document.getElementById('downloadFinalButton');

        let imageEditor;
        let currentFile = null;

        // --- File Handling ---
        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                currentFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                uploadSection.classList.add('hidden');
                previewSection.classList.remove('hidden');
                message.classList.add('hidden');
                editorSection.classList.add('hidden');
            } else {
                showMessage('Por favor, selecione um arquivo de imagem válido (PNG, JPG, WEBP).', 'error');
            }
        }
        
        function resetUI() {
            currentFile = null;
            fileInput.value = ''; // Reset file input
            originalImage.src = 'https://placehold.co/400x400/e2e8f0/cbd5e0?text=Enviar+Imagem';
            
            uploadSection.classList.remove('hidden');
            previewSection.classList.add('hidden');
            editorSection.classList.add('hidden');
            message.classList.add('hidden');
            processedImageWrapper.classList.add('hidden');
            previewGrid.classList.remove('md:grid-cols-2');
            previewGrid.classList.add('md:grid-cols-1');
            previewButtons.classList.remove('hidden');
        }

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        removeButton.addEventListener('click', resetUI);

        // --- Drag and Drop Event Listeners ---
        fileLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileLabel.classList.add('bg-blue-100', 'border-blue-500');
        });

        fileLabel.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileLabel.classList.remove('bg-blue-100', 'border-blue-500');
        });

        fileLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileLabel.classList.remove('bg-blue-100', 'border-blue-500');
            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                handleFile(files[0]);
            }
        });

        // Step 1: Process the image
        processButton.addEventListener('click', async () => {
            if (!currentFile) {
                showMessage('Por favor, selecione um arquivo de imagem.', 'error');
                return;
            }

            loading.classList.remove('hidden');
            message.classList.add('hidden');
            processedImage.src = 'https://placehold.co/400x400/e2e8f0/cbd5e0?text=Processando...';
            processedImageWrapper.classList.remove('hidden');
            previewGrid.classList.remove('md:grid-cols-1');
            previewGrid.classList.add('md:grid-cols-2');
            processButton.disabled = true;
            removeButton.disabled = true;

            const formData = new FormData();
            formData.append('image_file', currentFile);

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/process-image`, { method: 'POST', body: formData });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `O servidor respondeu com o status: ${response.status}`);
                }

                const imageBlob = await response.blob();
                const objectURL = URL.createObjectURL(imageBlob);
                
                processedImage.src = objectURL;
                showMessage('Imagem processada com sucesso! Você pode fazer mais edições abaixo.', 'success');
                
                previewButtons.classList.add('hidden');
                editorSection.classList.remove('hidden');

                if (imageEditor) {
                    await imageEditor.loadImageFromURL(objectURL, 'ProcessedImage');
                    imageEditor.clearUndoStack();
                } else {
                    imageEditor = new tui.ImageEditor('#tui-image-editor-container', {
                        includeUI: {
                            loadImage: { path: objectURL, name: 'ProcessedImage' },
                            theme: {},
                            menu: ['resize', 'crop', 'flip', 'rotate', 'draw', 'shape', 'icon', 'text', 'mask', 'filter'],
                            initMenu: 'filter',
                            uiSize: { height: '800px' },
                            menuBarPosition: 'bottom',
                        },
                        cssMaxWidth: 700,
                        cssMaxHeight: 800,
                        selectionStyle: { cornerSize: 20, rotatingPointOffset: 70 },
                    });
                }
            } catch (error) {
                handleError(error);
            } finally {
                loading.classList.add('hidden');
                processButton.disabled = false;
                removeButton.disabled = false;
            }
        });

        // Step 2: Download the final image
        downloadFinalButton.addEventListener('click', async () => {
            if (!imageEditor) return;

            loading.classList.remove('hidden');
            message.classList.add('hidden');
            downloadFinalButton.disabled = true;

            try {
                const dataURL = imageEditor.toDataURL();
                const blob = await (await fetch(dataURL)).blob();

                const formData = new FormData();
                formData.append('image_file', blob, 'final-image.png');
                
                const response = await fetch(`${BACKEND_BASE_URL}/add-corner-pixels`, { method: 'POST', body: formData });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `O servidor respondeu com o status: ${response.status}`);
                }

                const finalBlob = await response.blob();
                const objectURL = URL.createObjectURL(finalBlob);

                const tempLink = document.createElement('a');
                tempLink.href = objectURL;
                tempLink.download = 'imagem-final-com-pixels.png';
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
                URL.revokeObjectURL(objectURL);

                showMessage('Imagem final baixada com sucesso!', 'success');

            } catch (error) {
                handleError(error);
            } finally {
                loading.classList.add('hidden');
                downloadFinalButton.disabled = false;
            }
        });

        function handleError(error) {
            console.error('Erro:', error);
            if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                const serverErrorMessage = `Erro: Não foi possível conectar ao servidor. Por favor, verifique se ele está rodando e acessível em ${BACKEND_BASE_URL}.`;
                showMessage(serverErrorMessage, 'error');
            } else {
                showMessage(`Ocorreu um erro: ${error.message}`, 'error');
            }
            processedImage.src = 'https://placehold.co/400x400/f87171/ffffff?text=Erro';
        }

        function showMessage(text, type) {
            message.textContent = text;
            message.className = 'my-4 p-4 rounded-lg text-center'; // Reset classes
            if (type === 'success') {
                message.classList.add('bg-green-100', 'text-green-800');
            } else {
                message.classList.add('bg-red-100', 'text-red-800');
            }
            message.classList.remove('hidden');
        }
    </script>
</body>
</html>
