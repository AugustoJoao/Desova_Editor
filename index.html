<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photoroom Image Editor</title>
    <!-- TUI Image Editor CSS -->
    <link type="text/css" href="https://uicdn.toast.com/tui-color-picker/v2.2.7/tui-color-picker.css" rel="stylesheet">
    <link type="text/css" href="https://uicdn.toast.com/tui-image-editor/v3.15.3/tui-image-editor.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Ensure the editor has a defined height */
        #tui-image-editor-container {
            height: 800px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Photoroom Image Editor</h1>
            <p class="text-md sm:text-lg text-gray-600 mt-2">Upload an image to remove the background, resize it, and add corner pixels.</p>
        </header>

        <main class="bg-white rounded-2xl shadow-lg p-6 md:p-8 max-w-7xl mx-auto">

            <div id="upload-section">
                <!-- Instructions for running the server -->
                <div id="instructions" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-lg" role="alert">
                    <p class="font-bold">Setup Required</p>
                    <p>This frontend now communicates with a backend server. Please make sure the Node.js server is running on `http://localhost:3000` before processing an image.</p>
                </div>

                <!-- File Input -->
                <div class="mb-6">
                     <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2">Choose an image:</label>
                    <div class="flex items-center justify-center w-full">
                        <label for="fileInput" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                                </svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                <p class="text-xs text-gray-500">PNG, JPG, or WEBP</p>
                            </div>
                            <input id="fileInput" type="file" class="hidden" accept="image/png, image/jpeg, image/webp" />
                        </label>
                    </div>
                </div>

                <!-- Process Button -->
                <div class="text-center mb-6">
                    <button id="processButton" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Process Image
                    </button>
                </div>
            </div>

            <!-- Loading and Message Display -->
            <div id="loading" class="hidden text-center my-4">
                <div class="inline-block spinner w-8 h-8 border-4 rounded-full" role="status"></div>
                <p class="text-gray-600 mt-2">Processing your image, please wait...</p>
            </div>
            <div id="message" class="hidden text-center my-4 p-4 rounded-lg"></div>

            <!-- Image Display and Editor Section -->
            <div id="editor-section" class="hidden">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 mb-8">
                    <div class="text-center">
                        <h2 class="text-xl font-semibold mb-4">Original Image</h2>
                        <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden">
                            <img id="originalImage" src="https://placehold.co/400x400/e2e8f0/cbd5e0?text=Upload+Image" alt="Original" class="max-w-full max-h-full object-contain">
                        </div>
                    </div>
                    <div class="text-center md:col-span-2">
                        <h2 class="text-xl font-semibold mb-4">Image Ready to Edit</h2>
                        <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden">
                            <img id="processedImage" src="https://placehold.co/400x400/e2e8f0/cbd5e0?text=Result" alt="Processed" class="max-w-full max-h-full object-contain">
                        </div>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-center mb-4">Continue Editing</h2>
                <div id="tui-image-editor-container"></div>
                <div class="text-center mt-6">
                    <button id="downloadFinalButton" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                        Download Final Image
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- TUI Image Editor JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.6.0/fabric.min.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui-code-snippet/v1.5.2/tui-code-snippet.min.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui-color-picker/v2.2.7/tui-color-picker.min.js"></script>
    <script type="text/javascript" src="https://uicdn.toast.com/tui-image-editor/v3.15.3/tui-image-editor.min.js"></script>

    <script>
        // DOM element references
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const originalImage = document.getElementById('originalImage');
        const processedImage = document.getElementById('processedImage');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');
        const uploadSection = document.getElementById('upload-section');
        const editorSection = document.getElementById('editor-section');
        const downloadFinalButton = document.getElementById('downloadFinalButton');

        let imageEditor; // Variable to hold the TUI Image Editor instance

        // Display the selected image
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
                processedImage.src = 'https://placehold.co/400x400/e2e8f0/cbd5e0?text=Result';
                message.classList.add('hidden');
                editorSection.classList.add('hidden');
            }
        });

        // Step 1: Process the image on button click
        processButton.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Please select an image file.', 'error');
                return;
            }

            loading.classList.remove('hidden');
            message.classList.add('hidden');
            processedImage.src = 'https://placehold.co/400x400/e2e8f0/cbd5e0?text=Processing...';
            processButton.disabled = true;

            const formData = new FormData();
            formData.append('image_file', file);

            try {
                const backendUrl = 'http://localhost:3000/process-image';
                const response = await fetch(backendUrl, { method: 'POST', body: formData });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server responded with status: ${response.status}`);
                }

                const imageBlob = await response.blob();
                const objectURL = URL.createObjectURL(imageBlob);

                processedImage.src = objectURL;
                showMessage('Image processed successfully! You can now make further edits below.', 'success');
                editorSection.classList.remove('hidden');

                if (imageEditor) {
                    await imageEditor.loadImageFromURL(objectURL, 'ProcessedImage');
                    imageEditor.clearUndoStack();
                } else {
                    imageEditor = new tui.ImageEditor('#tui-image-editor-container', {
                        includeUI: {
                            loadImage: { path: objectURL, name: 'ProcessedImage' },
                            theme: {},
                            menu: ['resize', 'crop', 'flip', 'rotate', 'draw', 'shape', 'icon', 'text', 'mask', 'filter'],
                            initMenu: 'filter',
                            uiSize: { height: '800px' },
                            menuBarPosition: 'bottom',
                        },
                        cssMaxWidth: 700,
                        cssMaxHeight: 800,
                        selectionStyle: { cornerSize: 20, rotatingPointOffset: 70 },
                    });
                }
            } catch (error) {
                handleError(error);
            } finally {
                loading.classList.add('hidden');
                processButton.disabled = false;
            }
        });

        // Step 2: Download the final image after TUI edits
        downloadFinalButton.addEventListener('click', async () => {
            if (!imageEditor) return;

            loading.classList.remove('hidden');
            message.classList.add('hidden');
            downloadFinalButton.disabled = true;

            try {
                const dataURL = imageEditor.toDataURL();
                const blob = await (await fetch(dataURL)).blob();

                const formData = new FormData();
                formData.append('image_file', blob, 'final-image.png');

                const backendUrl = 'http://localhost:3000/add-corner-pixels';
                const response = await fetch(backendUrl, { method: 'POST', body: formData });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server responded with status: ${response.status}`);
                }

                const finalBlob = await response.blob();
                const objectURL = URL.createObjectURL(finalBlob);

                // Create a temporary link to trigger the download
                const tempLink = document.createElement('a');
                tempLink.href = objectURL;
                tempLink.download = 'final-image-with-pixels.png';
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
                URL.revokeObjectURL(objectURL);

                showMessage('Final image downloaded!', 'success');

            } catch (error) {
                handleError(error);
            } finally {
                loading.classList.add('hidden');
                downloadFinalButton.disabled = false;
            }
        });

        function handleError(error) {
            console.error('Error:', error);
            if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                const serverErrorMessage = 'Error: Could not connect to the backend server. Please ensure it is running and accessible at http://localhost:3000.';
                showMessage(serverErrorMessage, 'error');
            } else {
                showMessage(`An error occurred: ${error.message}`, 'error');
            }
            processedImage.src = 'https://placehold.co/400x400/f87171/ffffff?text=Error';
        }

        function showMessage(text, type) {
            message.textContent = text;
            message.className = 'my-4 p-4 rounded-lg text-center'; // Reset classes
            if (type === 'success') {
                message.classList.add('bg-green-100', 'text-green-800');
            } else {
                message.classList.add('bg-red-100', 'text-red-800');
            }
            message.classList.remove('hidden');
        }
    </script>
</body>
</html>
